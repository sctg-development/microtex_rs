name: CI

on:
  push:
    branches: main
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-macos-amd64:
    name: Build macOS (amd64)
    runs-on: macos-latest
    env:
      TARGET: x86_64-apple-darwin
      MICROTEX_BUNDLE_DIR: dependencies_bundle/macos/intel
    steps:
      - uses: actions/checkout@v6
      - name: Install dependencies for pkg-config
        run: brew install pkg-config pipx
      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: Cache cargo registry
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      - name: Add target
        run: rustup target add $TARGET
      - name: Build (release for $TARGET)
        run: cargo build --workspace --all-features --release --target $TARGET

      - name: Bundle diagnostic (if failure)
        if: failure()
        shell: bash
        run: |
          set -euo pipefail
          PKGDIR=dependencies_bundle/macos/intel/lib/pkgconfig
          echo "Listing pkgconfig files in bundle:"
          ls -la "$PKGDIR" || true
          missing=0
          pkgs="pango pangocairo cairo fontconfig libpng zlib bzip2 libffi freetype2 harfbuzz pixman-1 libpcre2-8"
          for pkg in $pkgs; do
            echo "Checking $pkg..."
            PKG_CONFIG_PATH=$PKGDIR pkg-config --exists "$pkg" || {
              echo "MISSING: $pkg"
              PKG_CONFIG_PATH=$PKGDIR pkg-config --print-errors --libs --cflags "$pkg" || true
              missing=1
            }
          done
          if [ "$missing" -ne 0 ]; then
            echo "Bundle diagnostic: missing pkg-config entries"
            exit 1
          fi

      - name: Collect bundle diagnostics (if failure)
        if: failure()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p bundle-diagnostics
          cp -a dependencies_bundle/macos/intel/lib/pkgconfig bundle-diagnostics/pkgconfig || true
          PKGDIR=dependencies_bundle/macos/intel/lib/pkgconfig
          for pkg in pango pangocairo cairo fontconfig libpng zlib bzip2 libffi freetype2 harfbuzz pixman-1 libpcre2-8; do
            echo "----- $pkg -----" > bundle-diagnostics/$pkg.log
            PKG_CONFIG_PATH=$PKGDIR pkg-config --print-errors --libs --cflags "$pkg" >> bundle-diagnostics/$pkg.log 2>&1 || true
          done
          tar -czf bundle-diagnostics.tar.gz bundle-diagnostics || true

      - name: Upload bundle diagnostics artifact (if failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: bundle-diagnostics-${{ github.run_id }}
          path: bundle-diagnostics.tar.gz
          retention-days: 7


  validate-bundle-macos:
    name: Validate macOS Intel bundle
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install pkg-config
        run: sudo apt-get update && sudo apt-get install -y pkg-config
      - name: List bundle pkgconfig files
        run: |
          echo "Bundle pkgconfig content:"
          ls -la dependencies_bundle/macos/intel/lib/pkgconfig || true
      - name: Validate required pkg-config entries
        run: |
          set -euo pipefail
          PKGDIR=dependencies_bundle/macos/intel/lib/pkgconfig
          missing=0
          pkgs="pango pangocairo cairo fontconfig libpng zlib bzip2 libffi freetype2 harfbuzz pixman-1 libpcre2-8"
          for pkg in $pkgs; do
            echo "Checking $pkg..."
            PKG_CONFIG_PATH=$PKGDIR pkg-config --exists "$pkg" || {
              echo "MISSING: $pkg"
              PKG_CONFIG_PATH=$PKGDIR pkg-config --print-errors --libs --cflags "$pkg" || true
              missing=1
            }
          done
          if [ "$missing" -ne 0 ]; then
            echo "Bundle validation failed: missing packages"
            exit 1
          fi

      - name: Collect bundle diagnostics (if failure)
        if: failure()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p bundle-diagnostics
          cp -a dependencies_bundle/macos/intel/lib/pkgconfig bundle-diagnostics/pkgconfig || true
          PKGDIR=dependencies_bundle/macos/intel/lib/pkgconfig
          for pkg in pango pangocairo cairo fontconfig libpng zlib bzip2 libffi freetype2 harfbuzz pixman-1 libpcre2-8; do
            echo "----- $pkg -----" > bundle-diagnostics/$pkg.log
            PKG_CONFIG_PATH=$PKGDIR pkg-config --print-errors --libs --cflags "$pkg" >> bundle-diagnostics/$pkg.log 2>&1 || true
          done
          tar -czf bundle-diagnostics.tar.gz bundle-diagnostics || true

      - name: Upload bundle diagnostics artifact (if failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: bundle-diagnostics-${{ github.run_id }}
          path: bundle-diagnostics.tar.gz
          retention-days: 7

  build-macos-arm64:
    name: Build macOS (arm64)
    # This job targets a macOS arm64 runner (macos-latest is arm64).
    runs-on: macos-latest
    env:
      TARGET: aarch64-apple-darwin
    steps:
      - uses: actions/checkout@v6
      # install meson and nija with --break-system-packages
      - name: Install meson and ninja
        run: |
          python3 -m pip install --break-system-packages meson ninja
      - name: Install dependencies
        run: brew install cairo pango fontconfig pkg-config lzo pipx
      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: Add target (aarch64)
        run: rustup target add $TARGET || true
      - name: Build (release for host)
        # Build for the native host architecture; explicit target available as $TARGET
        run: cargo build --workspace --all-features --release --target $TARGET
      - name: Run tests (host)
        # Tests run on the runner for the host arch
        run: cargo test --workspace --all-features --no-fail-fast

      - name: Collect Meson logs (if failure)
        if: failure()
        shell: bash
        run: |
          set -eu
          echo "Searching for meson logs..."
          find . -type f -name 'meson-log.txt' -path '*/vendored/*/build/meson-logs/meson-log.txt' -print > meson-log-paths.txt || true
          if [ ! -s meson-log-paths.txt ]; then
            echo "No meson logs found"
            exit 0
          fi
          mkdir -p meson-logs
          while IFS= read -r p; do
            fn=$(echo "$p" | sed 's|[./]|_|g' | sed 's|__|_|g')
            cp "$p" "meson-logs/$fn" || cp "$p" "meson-logs/$(basename $p)"
            echo "Copied $p -> meson-logs/$fn"
          done < meson-log-paths.txt
          ls -la meson-logs || true

      - name: Upload Meson logs artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: meson-logs-${{ env.TARGET }}
          path: meson-logs
          retention-days: 7

  build-ubuntu:
    name: Build Ubuntu (amd64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libcairo2-dev libpango1.0-dev libfontconfig1-dev pkg-config
      # install meson and nija with --break-system-packages
      - name: Install meson and ninja
        run: |
          python3 -m pip install --break-system-packages meson ninja
      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: Install system deps
        run: |
          sudo apt-get update && sudo apt-get install -y pkg-config libssl-dev clang
      - name: Build (release)
        run: cargo build --workspace --all-features --release
      - name: Run tests
        run: cargo test --workspace --all-features --no-fail-fast

  coverage-tarpaulin:
    name: Coverage (tarpaulin) -> Codecov
    runs-on: ubuntu-latest
    needs: build-ubuntu
    steps:
      - uses: actions/checkout@v6
      # install meson and nija with --break-system-packages
      - name: Install meson and ninja
        run: |
          python3 -m pip install --break-system-packages meson ninja
      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      # install meson and nija with --break-system-packages
      - name: Install meson and ninja
        run: |
          python3 -m pip install --break-system-packages meson ninja
      - name: Install system deps for tarpaulin
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev clang llvm
      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin || true
      - name: Run tarpaulin and generate Cobertura XML
        # Generate coverage report in Cobertura-compatible XML
        run: |
          cargo tarpaulin --out Xml || true
          # tarpaulin may output multiple xml filenames; normalize to cobertura.xml
          if [ -f tarpaulin-report.xml ]; then mv tarpaulin-report.xml cobertura.xml; fi
          if [ -f coverage.xml ] && [ ! -f cobertura.xml ]; then mv coverage.xml cobertura.xml; fi
          ls -la || true
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: cobertura.xml
          flags: tarpaulin
          slug: sctg-development/microtex_rs
          token: ${{ secrets.CODECOV_TOKEN }}
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
